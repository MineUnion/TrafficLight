name: TrafficLight CI/CD

# è§¦å‘æ¡ä»¶ï¼špush åˆ°ä»»æ„åˆ†æ”¯ã€æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ '*' ] # åŒ¹é…æ‰€æœ‰åˆ†æ”¯
    tags: [ 'v*' ]    # ç‰ˆæœ¬æ ‡ç­¾è§¦å‘
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  # æ„å»ºæ ¡éªŒä»»åŠ¡
  build:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check_commit.outputs.should_release }}
      version: ${{ steps.extract_version.outputs.version }}
      jar_name: ${{ steps.build.outputs.jar_name }}

    steps:
      # 1. æ£€æŸ¥ä»£ç ï¼ˆæ‹‰å–å®Œæ•´å†å²ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. æ£€æŸ¥Commitä¿¡æ¯ï¼Œåˆ¤æ–­æ„å»º/å‘å¸ƒé€»è¾‘
      - name: Check commit message
        id: check_commit
        run: |
          # è·å–æœ€æ–°commitä¿¡æ¯ï¼ˆå®¹é”™ï¼šå…¼å®¹æ‰‹åŠ¨è§¦å‘/PRåœºæ™¯ï¼‰
          COMMIT_MSG=$(git log -1 --pretty=format:"%s" 2>/dev/null || echo "manual trigger")
          echo "Latest commit message: $COMMIT_MSG"
          
          # æ£€æµ‹[miss build]ï¼Œç»ˆæ­¢æ„å»º
          if echo "$COMMIT_MSG" | grep -qi "\[miss build\]"; then
            echo "âŒ Commit contains [miss build], aborting build..."
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æµ‹[release]ï¼Œæ ‡è®°å‘å¸ƒ
          if echo "$COMMIT_MSG" | grep -qi "\[release\]"; then
            echo "âœ… Commit contains [release], will create Release later"
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No [release] in commit, skip Release creation"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi
          
          echo "should_build=true" >> $GITHUB_OUTPUT
        shell: bash

      # 3. è·³è¿‡æ„å»ºï¼ˆå¦‚æœæ ‡è®°ä¸ºä¸æ„å»ºï¼‰
      - name: Skip build if needed
        if: steps.check_commit.outputs.should_build == 'false'
        run: |
          echo "Build aborted due to [miss build] in commit"
          exit 0
        shell: bash

      # 4. é…ç½®JDK 17ï¼ˆè‡ªåŠ¨ç¼“å­˜ï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®šJAVA_HOMEï¼‰
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven # è‡ªåŠ¨ç¼“å­˜Mavenä¾èµ–

      # 5. æå–ç‰ˆæœ¬å·ï¼ˆå¢å¼ºå®¹é”™+æ ‡å‡†åŒ–ï¼‰
      - name: Extract version
        id: extract_version
        run: |
          set -euo pipefail # ä¸¥æ ¼æ¨¡å¼ï¼šä»»æ„é”™è¯¯ç«‹å³ç»ˆæ­¢
          
          # ä»pom.xmlæå–ç‰ˆæœ¬ï¼ˆæ·»åŠ Mavené•œåƒ+SSLå®¹é”™ï¼‰
          VERSION=$(
            mvn help:evaluate -Dexpression=project.version -q -DforceStdout \
            -Dmaven.wagon.http.ssl.insecure=true \
            -Dmaven.wagon.http.ssl.allowall=true \
            -Dmaven.wagon.http.ssl.ignore.validity.dates=true 2>/dev/null || echo "1.0.0-SNAPSHOT"
          )
          
          # å®¹é”™ï¼šç©ºç‰ˆæœ¬å¤„ç†
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            VERSION="1.0.0-SNAPSHOT"
            echo "âš ï¸ ä»pom.xmlæå–ç‰ˆæœ¬å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬ï¼š$VERSION"
          fi
          echo "åŸå§‹ç‰ˆæœ¬å·ï¼š$VERSION"
          
          # å¿«ç…§ç‰ˆè¿½åŠ åˆ†æ”¯+æäº¤å“ˆå¸Œï¼ˆæ ‡å‡†åŒ–å‘½åï¼‰
          if echo "$VERSION" | grep -qi "SNAPSHOT"; then
            # æäº¤å“ˆå¸Œï¼ˆå®¹é”™ï¼‰
            COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
            # åˆ†æ”¯åï¼ˆå…¼å®¹æ‰€æœ‰è§¦å‘åœºæ™¯ï¼Œç‰¹æ®Šå­—ç¬¦æ›¿æ¢ï¼‰
            BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9_\-]/-/g' | cut -c1-30)
            BRANCH_NAME=${BRANCH_NAME:-"unknown-branch"} # ç©ºå€¼å®¹é”™
            # æ‹¼æ¥ç‰ˆæœ¬ï¼ˆé¿å…é‡å¤åˆ†éš”ç¬¦ï¼‰
            VERSION=$(echo "$VERSION" | sed 's/-SNAPSHOT//')"-SNAPSHOT-${BRANCH_NAME}-${COMMIT_HASH}"
          fi
          
          # è¾“å‡ºæœ€ç»ˆç‰ˆæœ¬
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… æœ€ç»ˆç‰ˆæœ¬å·ï¼š$VERSION"
        shell: bash

      # 6. æ„å»ºMavené¡¹ç›®ï¼ˆå¢å¼ºå®¹é”™+äº§ç‰©æ ¡éªŒï¼‰
      - name: Build with Maven
        id: build
        run: |
          set -euo pipefail
          
          # æ‰§è¡ŒMavenæ‰“åŒ…ï¼ˆå¼ºåˆ¶åˆ·æ–°å¿«ç…§+SSLå®¹é”™ï¼‰
          mvn clean package -B \
            -Dmaven.wagon.http.ssl.insecure=true \
            -Dmaven.wagon.http.ssl.allowall=true \
            -Dmaven.wagon.http.ssl.ignore.validity.dates=true \
            -U # å¼ºåˆ¶æ›´æ–°å¿«ç…§ä¾èµ–
          
          # æ ¡éªŒtargetç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "target" ]; then
            echo "âŒ targetç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
            exit 1
          fi
          
          # è·å–JaråŒ…åç§°ï¼ˆå®¹é”™ï¼šå…¼å®¹å¤šJar/æ— Jaråœºæ™¯ï¼‰
          JAR_FILES=$(ls target/*.jar 2>/dev/null | grep -v "original-" || true)
          if [ -z "$JAR_FILES" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°æ„å»ºçš„JaråŒ…ï¼Œä½¿ç”¨é»˜è®¤åç§°"
            JAR_NAME="TrafficLight-unknown.jar"
          else
            JAR_NAME=$(basename "$JAR_FILES" | head -n1) # å–ç¬¬ä¸€ä¸ªJaråŒ…
          fi
          
          echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT
          echo "âœ… æ„å»ºäº§ç‰©ï¼š$JAR_NAME"
          
          # å¤åˆ¶äº§ç‰©åˆ°ç»Ÿä¸€ç›®å½•ï¼ˆå®¹é”™ï¼‰
          mkdir -p build-output
          if [ -f "target/$JAR_NAME" ]; then
            cp "target/$JAR_NAME" build-output/
            echo "âœ… å¤åˆ¶JaråŒ…åˆ°build-outputç›®å½•"
          else
            echo "âš ï¸ JaråŒ…ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤åˆ¶"
            touch build-output/empty.txt # é¿å…ä¸Šä¼ ä¸ºç©º
          fi
          
          # åˆ—å‡ºäº§ç‰©ç›®å½•
          ls -la build-output/
        shell: bash

      # 7. ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆå®¹é”™ï¼šå…è®¸ç©ºç›®å½•ï¼‰
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrafficLight-${{ steps.extract_version.outputs.version }}
          path: build-output/
          retention-days: 7
          if-no-files-found: warn # æ— æ–‡ä»¶æ—¶ä»…è­¦å‘Šï¼Œä¸ç»ˆæ­¢

  # è‡ªåŠ¨åˆ›å»ºReleaseä»»åŠ¡ï¼ˆä»…å½“æ ‡è®°ä¸ºéœ€è¦Releaseæ—¶æ‰§è¡Œï¼‰
  release:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.should_release == 'true'
    steps:
      # 1. ä¸‹è½½æ„å»ºäº§ç‰©
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: TrafficLight-${{ needs.build.outputs.version }}
          path: build-output

      # 2. æ ¡éªŒäº§ç‰©æ˜¯å¦å­˜åœ¨
      - name: Validate build artifact
        run: |
          set -euo pipefail
          if [ ! -f "build-output/${{ needs.build.outputs.jar_name }}" ]; then
            echo "âŒ æ„å»ºäº§ç‰©ä¸å­˜åœ¨ï¼Œå‘å¸ƒå¤±è´¥"
            exit 1
          fi
          ls -la build-output/
        shell: bash

      # 3. åˆ›å»ºGitHub Releaseï¼ˆä¿®å¤æ ‡ç­¾/åç§°/æ­£æ–‡è¯­æ³•ï¼‰
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # æ ‡å‡†åŒ–æ ‡ç­¾ï¼ˆç¡®ä¿ä»¥vå¼€å¤´ï¼‰
          tag_name: ${{ format('v{0}', needs.build.outputs.version) }}
          # Releaseåç§°ï¼ˆæ ‡å‡†åŒ–ï¼‰
          name: "TrafficLight ${{ needs.build.outputs.version }} (${{ github.ref_name }})"
          # Releaseæ­£æ–‡ï¼ˆå…¼å®¹æ— æäº¤ä¿¡æ¯åœºæ™¯ï¼‰
          body: |
            ## ğŸš€ TrafficLight Release ${{ needs.build.outputs.version }}
            ### åˆ†æ”¯ï¼š${{ github.ref_name }} | æ„å»ºæ—¶é—´ï¼š${{ github.run_at }}
            ### æäº¤å“ˆå¸Œï¼š${{ github.sha }}
            ${{ github.event.head_commit.message && format('### æäº¤ä¿¡æ¯ï¼š{0}', github.event.head_commit.message) || '### è§¦å‘æ–¹å¼ï¼šæ‰‹åŠ¨æ„å»º' }}
            
            #### æ„å»ºè¯´æ˜
            - åŸºäº `${{ github.ref_name }}` åˆ†æ”¯æ„å»º
            - é€‚é… Paper 1.20+ (Java 17)
            - äº§ç‰©ï¼š${{ needs.build.outputs.jar_name }}
          # ä¸Šä¼ äº§ç‰©ï¼ˆç»å¯¹è·¯å¾„å®¹é”™ï¼‰
          files: ${{ github.workspace }}/build-output/${{ needs.build.outputs.jar_name }}
          # é¢„å‘å¸ƒæ ‡è®°ï¼ˆå…¼å®¹main/masteråˆ†æ”¯ï¼‰
          prerelease: ${{ github.ref_name != 'main' && github.ref_name != 'master' }}
          # å…è®¸è¦†ç›–å·²æœ‰æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
