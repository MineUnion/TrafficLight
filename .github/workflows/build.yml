name: TrafficLight CI/CD

# è§¦å‘æ¡ä»¶ï¼špush åˆ°ä»»æ„åˆ†æ”¯ã€æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ '*' ] # åŒ¹é…æ‰€æœ‰åˆ†æ”¯ï¼ˆåŒ…æ‹¬ mainã€devã€feature/* ç­‰ï¼‰
    tags: [ 'v*' ]    # ä¿ç•™ç‰ˆæœ¬æ ‡ç­¾è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # æ„å»ºæ ¡éªŒä»»åŠ¡
  build:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check_commit.outputs.should_release }}
      version: ${{ steps.extract_version.outputs.version }}
      jar_name: ${{ steps.build.outputs.jar_name }}

    steps:
      # 1. æ£€æŸ¥ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # æ‹‰å–æ‰€æœ‰æäº¤è®°å½•

      # 2. æ£€æŸ¥Commitä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ‹’ç»æ„å»º/æ˜¯å¦åˆ›å»ºRelease
      - name: Check commit message
        id: check_commit
        run: |
          # è·å–æœ€æ–°commitä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "Latest commit message: $COMMIT_MSG"
          
          # æ£€æµ‹æ˜¯å¦åŒ…å« [miss build]ï¼Œæ‹’ç»æ‰§è¡Œ
          if echo "$COMMIT_MSG" | grep -qi "\[miss build\]"; then
            echo "âŒ Commit contains [miss build], aborting build..."
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æµ‹æ˜¯å¦åŒ…å« [release]ï¼Œæ ‡è®°éœ€è¦åˆ›å»ºRelease
          if echo "$COMMIT_MSG" | grep -qi "\[release\]"; then
            echo "âœ… Commit contains [release], will create Release later"
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No [release] in commit, skip Release creation"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi
          
          echo "should_build=true" >> $GITHUB_OUTPUT

      # 3. è·³è¿‡æ„å»ºï¼ˆå¦‚æœæ ‡è®°ä¸ºä¸æ„å»ºï¼‰
      - name: Skip build if needed
        if: steps.check_commit.outputs.should_build == 'false'
        run: |
          echo "Build aborted due to [miss build] in commit"
          exit 0

      # 4. é…ç½®JDK 17ï¼ˆé€‚é…Paper 1.20+ï¼‰
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven # ç¼“å­˜Mavenä¾èµ–

      # 5. æå–ç‰ˆæœ¬å·ï¼ˆä»pom.xmlè§£æï¼‰
      - name: Extract version
        id: extract_version
        run: |
          # ä¼˜å…ˆä»pom.xmlæå–ç‰ˆæœ¬å·
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          # å¦‚æœæ˜¯å¿«ç…§ç‰ˆï¼Œè¿½åŠ æäº¤å“ˆå¸Œå’Œåˆ†æ”¯å
          if echo "$VERSION" | grep -qi "SNAPSHOT"; then
            COMMIT_HASH=$(git rev-parse --short HEAD)
            BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/\//-/g') # æ›¿æ¢åˆ†æ”¯åä¸­çš„/ä¸º-
            VERSION="${VERSION}-${BRANCH_NAME}-${COMMIT_HASH}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      # 6. æ„å»ºMavené¡¹ç›®
      - name: Build with Maven
        id: build
        run: |
          # æ‰§è¡ŒMavenæ‰“åŒ…
          mvn clean package -B
          # è·å–ç”Ÿæˆçš„JaråŒ…åç§°
          JAR_NAME=$(ls target/*.jar | grep -v "original-" | xargs -n1 basename)
          echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT
          echo "Built Jar: $JAR_NAME"
          
          # å¤åˆ¶JaråŒ…åˆ°æ˜“è®¿é—®çš„ç›®å½•
          mkdir -p build-output
          cp target/$JAR_NAME build-output/
          ls -la build-output/

      # 7. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrafficLight-${{ steps.extract_version.outputs.version }}
          path: build-output/*.jar
          retention-days: 7

  # è‡ªåŠ¨åˆ›å»ºReleaseä»»åŠ¡ï¼ˆä»…å½“æ ‡è®°ä¸ºéœ€è¦Releaseæ—¶æ‰§è¡Œï¼‰
  release:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.should_release == 'true'
    steps:
      # 1. ä¸‹è½½æ„å»ºäº§ç‰©
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: TrafficLight-${{ needs.build.outputs.version }}
          path: build-output

      # 2. åˆ›å»ºGitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # Releaseæ ‡é¢˜å’Œæ ‡ç­¾ï¼ˆè¿½åŠ åˆ†æ”¯åï¼Œé¿å…å†²çªï¼‰
          tag_name: v${{ needs.build.outputs.version }}
          name: TrafficLight v${{ needs.build.outputs.version }} (${{ github.ref_name }})
          body: |
            ## ğŸš€ TrafficLight Release v${{ needs.build.outputs.version }}
            ### åˆ†æ”¯ï¼š${{ github.ref_name }} | æ„å»ºæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
            ### æäº¤å“ˆå¸Œï¼š${{ github.sha }} | æäº¤ä¿¡æ¯ï¼š${{ github.event.head_commit.message }}
            
            #### è‡ªåŠ¨æ„å»ºè¯´æ˜
            - åŸºäº `${{ github.ref_name }}` åˆ†æ”¯æœ€æ–°æäº¤æ„å»º
            - JaråŒ…é€‚é… Paper 1.20+ (Java 17)
          # ä¸Šä¼ JaråŒ…åˆ°Release
          files: build-output/${{ needs.build.outputs.jar_name }}
          # éä¸»åˆ†æ”¯æ ‡è®°ä¸ºé¢„å‘å¸ƒ
          prerelease: ${{ github.ref_name != 'main' && github.ref_name != 'master' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
