name: TrafficLight CI/CD

# è§¦å‘æ¡ä»¶ï¼špush åˆ°ä»»æ„åˆ†æ”¯ã€æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ '*' ] # åŒ¹é…æ‰€æœ‰åˆ†æ”¯
    tags: [ 'v*' ]    # ç‰ˆæœ¬æ ‡ç­¾è§¦å‘
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

# æ–°å¢ï¼šæ·»åŠ æƒé™å£°æ˜ï¼ˆè§£å†³ 403 æƒé™ä¸è¶³é—®é¢˜ï¼‰
permissions:
  contents: write # å…è®¸åˆ›å»º/ä¿®æ”¹ Releaseï¼ˆæ ¸å¿ƒæƒé™ï¼‰
  actions: read   # åªè¯»å·¥ä½œæµä¿¡æ¯ï¼ˆå¯é€‰ï¼ŒæŒ‰éœ€æ·»åŠ ï¼‰

jobs:
  # æ„å»ºæ ¡éªŒä»»åŠ¡ï¼ˆæ— ä¿®æ”¹ï¼Œä¿æŒåŸé€»è¾‘ï¼‰
  build:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check_commit.outputs.should_release }}
      version: ${{ steps.extract_version.outputs.version }}
      display_version: ${{ steps.extract_version.outputs.display_version }}
      jar_name: ${{ steps.build.outputs.jar_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit message
        id: check_commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s" 2>/dev/null || echo "manual trigger")
          echo "Latest commit message: $COMMIT_MSG"
          
          if echo "$COMMIT_MSG" | grep -qi "\[miss build\]"; then
            echo "âŒ Commit contains [miss build], aborting build..."
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if echo "$COMMIT_MSG" | grep -qi "\[release\]"; then
            echo "âœ… Commit contains [release], will create Release later"
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No [release] in commit, skip Release creation"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi
          
          echo "should_build=true" >> $GITHUB_OUTPUT
        shell: bash

      - name: Skip build if needed
        if: steps.check_commit.outputs.should_build == 'false'
        run: |
          echo "Build aborted due to [miss build] in commit"
          exit 0
        shell: bash

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Extract version
        id: extract_version
        run: |
          set -euo pipefail
          
          FULL_VERSION=$(
            mvn help:evaluate -Dexpression=project.version -q -DforceStdout \
            -Dmaven.wagon.http.ssl.insecure=true \
            -Dmaven.wagon.http.ssl.allowall=true \
            -Dmaven.wagon.http.ssl.ignore.validity.dates=true 2>/dev/null || echo "1.0.0"
          )
          
          if [ -z "$FULL_VERSION" ] || [ "$FULL_VERSION" = "null" ]; then
            FULL_VERSION="1.0.0"
            echo "âš ï¸ ä»pom.xmlæå–ç‰ˆæœ¬å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬ï¼š$FULL_VERSION"
          fi
          echo "å®Œæ•´ç‰ˆæœ¬ï¼ˆå«SNAPSHOTï¼‰ï¼š$FULL_VERSION"
          
          BASE_VERSION=$(echo "$FULL_VERSION" | sed 's/-SNAPSHOT//g')
          echo "åŸºç¡€ç‰ˆæœ¬å·ï¼š$BASE_VERSION"
          
          BUILD_NUMBER=${{ github.run_number }}
          echo "æ„å»ºå·ï¼š$BUILD_NUMBER"
          
          DISPLAY_VERSION="TrafficLight $BASE_VERSION build $BUILD_NUMBER"
          
          if echo "$FULL_VERSION" | grep -qi "SNAPSHOT"; then
            COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
            BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9_\-]/-/g' | cut -c1-30)
            BRANCH_NAME=${BRANCH_NAME:-"unknown-branch"}
            DISPLAY_VERSION="$DISPLAY_VERSION - $BRANCH_NAME - $COMMIT_HASH"
          fi
          
          echo "version=$BASE_VERSION-build-$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "display_version=$DISPLAY_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… æœ€ç»ˆå±•ç¤ºç‰ˆæœ¬ï¼š$DISPLAY_VERSION"
          echo "âœ… äº§ç‰©ç‰ˆæœ¬æ ‡è¯†ï¼š$BASE_VERSION-build-$BUILD_NUMBER"
        shell: bash

      - name: Build with Maven
        id: build
        run: |
          set -euo pipefail
          
          mvn clean package -B \
            -Dmaven.wagon.http.ssl.insecure=true \
            -Dmaven.wagon.http.ssl.allowall=true \
            -Dmaven.wagon.http.ssl.ignore.validity.dates=true \
            -U
          
          if [ ! -d "target" ]; then
            echo "âŒ targetç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
            exit 1
          fi
          
          BASE_VERSION=$(echo "${{ steps.extract_version.outputs.version }}" | cut -d'-' -f1)
          ORIGINAL_JAR=$(ls target/*.jar 2>/dev/null | grep -v "original-" | head -n1 || true)
          
          if [ -z "$ORIGINAL_JAR" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°æ„å»ºçš„JaråŒ…ï¼Œä½¿ç”¨é»˜è®¤åç§°"
            JAR_NAME="TrafficLight-$BASE_VERSION-build-${{ github.run_number }}.jar"
          else
            JAR_NAME="TrafficLight-$BASE_VERSION-build-${{ github.run_number }}.jar"
            cp "$ORIGINAL_JAR" "target/$JAR_NAME"
          fi
          
          echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT
          echo "âœ… æ„å»ºäº§ç‰©ï¼š$JAR_NAME"
          
          mkdir -p build-output
          if [ -f "target/$JAR_NAME" ]; then
            cp "target/$JAR_NAME" build-output/
            echo "âœ… å¤åˆ¶JaråŒ…åˆ°build-outputç›®å½•"
          else
            echo "âš ï¸ JaråŒ…ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤åˆ¶"
            touch build-output/empty.txt
          fi
          
          ls -la build-output/
        shell: bash

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.extract_version.outputs.display_version }}
          path: build-output/
          retention-days: 7
          if-no-files-found: warn

  # å‘å¸ƒä»»åŠ¡ï¼ˆä¿®å¤å‚æ•°å’Œæƒé™ç›¸å…³é—®é¢˜ï¼‰
  release:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.should_release == 'true'
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.display_version }}
          path: build-output

      - name: Validate build artifact
        run: |
          set -euo pipefail
          if [ ! -f "build-output/${{ needs.build.outputs.jar_name }}" ]; then
            echo "âŒ æ„å»ºäº§ç‰©ä¸å­˜åœ¨ï¼Œå‘å¸ƒå¤±è´¥"
            exit 1
          fi
          ls -la build-output/
        shell: bash

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: ${{ needs.build.outputs.display_version }}
          body: |
            ## ğŸš€ ${{ needs.build.outputs.display_version }}
            ### åˆ†æ”¯ï¼š${{ github.ref_name }} | æ„å»ºæ—¶é—´ï¼š${{ github.run_at }}
            ### æ„å»ºå·ï¼š${{ github.run_number }} | æäº¤å“ˆå¸Œï¼š${{ github.sha }}
            ${{ github.event.head_commit.message && format('### æäº¤ä¿¡æ¯ï¼š{0}', github.event.head_commit.message) || '### è§¦å‘æ–¹å¼ï¼šæ‰‹åŠ¨æ„å»º' }}
           
            #### æ„å»ºè¯´æ˜
            - åŸºäº `${{ github.ref_name }}` åˆ†æ”¯æ„å»º
            - äº§ç‰©ï¼š${{ needs.build.outputs.jar_name }}
          files: ${{ github.workspace }}/build-output/${{ needs.build.outputs.jar_name }}
          prerelease: ${{ github.ref_name != 'main' && github.ref_name != 'master' }}
          overwrite_files: true
          target_commitish: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨é»˜è®¤ä»¤ç‰Œï¼ˆå·²é€šè¿‡ permissions æˆæƒï¼‰
