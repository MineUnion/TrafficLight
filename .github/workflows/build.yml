name: TrafficLight CI/CD

# è§¦å‘æ¡ä»¶ï¼špush åˆ°ä¸»åˆ†æ”¯/æ ‡ç­¾ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ] # åŒ¹é… v1.0.0 ç­‰ç‰ˆæœ¬æ ‡ç­¾
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # æ„å»ºæ ¡éªŒä»»åŠ¡
  build:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check_commit.outputs.should_release }} # ä¼ é€’æ˜¯å¦åˆ›å»ºReleaseçš„æ ‡è®°
      version: ${{ steps.extract_version.outputs.version }} # ä¼ é€’ç‰ˆæœ¬å·
      jar_name: ${{ steps.build.outputs.jar_name }} # ä¼ é€’JaråŒ…åç§°

    steps:
      # 1. æ£€æŸ¥ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # æ‹‰å–æ‰€æœ‰æäº¤è®°å½•ï¼Œç”¨äºè§£æcommitä¿¡æ¯

      # 2. æ£€æŸ¥Commitä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ‹’ç»æ„å»º/æ˜¯å¦åˆ›å»ºRelease
      - name: Check commit message
        id: check_commit
        run: |
          # è·å–æœ€æ–°commitä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "Latest commit message: $COMMIT_MSG"
          
          # æ£€æµ‹æ˜¯å¦åŒ…å« [miss build]ï¼Œæ‹’ç»æ‰§è¡Œ
          if echo "$COMMIT_MSG" | grep -qi "\[miss build\]"; then
            echo "âŒ Commit contains [miss build], aborting build..."
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æµ‹æ˜¯å¦åŒ…å« [release]ï¼Œæ ‡è®°éœ€è¦åˆ›å»ºRelease
          if echo "$COMMIT_MSG" | grep -qi "\[release\]"; then
            echo "âœ… Commit contains [release], will create Release later"
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No [release] in commit, skip Release creation"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi
          
          echo "should_build=true" >> $GITHUB_OUTPUT

      # 3. è·³è¿‡æ„å»ºï¼ˆå¦‚æœæ ‡è®°ä¸ºä¸æ„å»ºï¼‰
      - name: Skip build if needed
        if: steps.check_commit.outputs.should_build == 'false'
        run: |
          echo "Build aborted due to [miss build] in commit"
          exit 0

      # 4. é…ç½®JDKï¼ˆé€‚é…Minecraftæ’ä»¶çš„Java 8ï¼‰
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: maven # ç¼“å­˜Mavenä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º

      # 5. æå–ç‰ˆæœ¬å·ï¼ˆä»pom.xmlæˆ–commitä¸­è§£æï¼‰
      - name: Extract version
        id: extract_version
        run: |
          # ä¼˜å…ˆä»pom.xmlæå–ç‰ˆæœ¬å·
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          # å¦‚æœæ˜¯å¿«ç…§ç‰ˆï¼Œè¿½åŠ æäº¤å“ˆå¸Œ
          if echo "$VERSION" | grep -qi "SNAPSHOT"; then
            COMMIT_HASH=$(git rev-parse --short HEAD)
            VERSION="${VERSION}-${COMMIT_HASH}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      # 6. æ„å»ºMavené¡¹ç›®
      - name: Build with Maven
        id: build
        run: |
          # æ‰§è¡ŒMavenæ‰“åŒ…
          mvn clean package -B
          # è·å–ç”Ÿæˆçš„JaråŒ…åç§°
          JAR_NAME=$(ls target/*.jar | grep -v "original-" | xargs -n1 basename)
          echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT
          echo "Built Jar: $JAR_NAME"
          
          # å¤åˆ¶JaråŒ…åˆ°æ˜“è®¿é—®çš„ç›®å½•ï¼ˆæ–¹ä¾¿åç»­ä¸Šä¼ ï¼‰
          mkdir -p build-output
          cp target/$JAR_NAME build-output/
          ls -la build-output/

      # 7. ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆä½œä¸ºArtifactï¼‰
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrafficLight-${{ steps.extract_version.outputs.version }}
          path: build-output/*.jar
          retention-days: 7 # ä¿ç•™7å¤©

  # è‡ªåŠ¨åˆ›å»ºReleaseä»»åŠ¡ï¼ˆä»…å½“æ ‡è®°ä¸ºéœ€è¦Releaseæ—¶æ‰§è¡Œï¼‰
  release:
    needs: build # ä¾èµ–buildä»»åŠ¡å®Œæˆ
    runs-on: ubuntu-latest
    if: needs.build.outputs.should_release == 'true'
    steps:
      # 1. ä¸‹è½½æ„å»ºäº§ç‰©
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: TrafficLight-${{ needs.build.outputs.version }}
          path: build-output

      # 2. åˆ›å»ºGitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # Releaseæ ‡é¢˜å’Œæ ‡ç­¾
          tag_name: v${{ needs.build.outputs.version }}
          name: TrafficLight v${{ needs.build.outputs.version }}
          body: |
            ## ğŸš€ TrafficLight Release v${{ needs.build.outputs.version }}
            ### è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼ŒåŸºäºæœ€æ–°æäº¤ç”Ÿæˆ
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - æäº¤å“ˆå¸Œ: ${{ github.sha }}
            
            ### æ›´æ–°å†…å®¹
            ${{ github.event.head_commit.message }}
          # ä¸Šä¼ JaråŒ…åˆ°Release
          files: build-output/${{ needs.build.outputs.jar_name }}
          # æ ‡è®°ä¸ºé¢„å‘å¸ƒï¼ˆå¯é€‰ï¼‰
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHubè‡ªåŠ¨ç”Ÿæˆçš„ä»¤ç‰Œï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
