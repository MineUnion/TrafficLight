name: TrafficLight CI/CD

# è§¦å‘æ¡ä»¶ï¼špush åˆ°ä»»æ„åˆ†æ”¯ã€æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ '*' ] # åŒ¹é…æ‰€æœ‰åˆ†æ”¯ï¼ˆåŒ…æ‹¬ mainã€devã€feature/* ç­‰ï¼‰
    tags: [ 'v*' ]    # ä¿ç•™ç‰ˆæœ¬æ ‡ç­¾è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # æ„å»ºæ ¡éªŒä»»åŠ¡
  build:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check_commit.outputs.should_release }}
      version: ${{ steps.extract_version.outputs.version }}
      jar_name: ${{ steps.build.outputs.jar_name }}

    steps:
      # 1. æ£€æŸ¥ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # æ‹‰å–æ‰€æœ‰æäº¤è®°å½•

      # 2. æ£€æŸ¥Commitä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ‹’ç»æ„å»º/æ˜¯å¦åˆ›å»ºRelease
      - name: Check commit message
        id: check_commit
        run: |
          # è·å–æœ€æ–°commitä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "Latest commit message: $COMMIT_MSG"
          
          # æ£€æµ‹æ˜¯å¦åŒ…å« [miss build]ï¼Œæ‹’ç»æ‰§è¡Œ
          if echo "$COMMIT_MSG" | grep -qi "\[miss build\]"; then
            echo "âŒ Commit contains [miss build], aborting build..."
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æµ‹æ˜¯å¦åŒ…å« [release]ï¼Œæ ‡è®°éœ€è¦åˆ›å»ºRelease
          if echo "$COMMIT_MSG" | grep -qi "\[release\]"; then
            echo "âœ… Commit contains [release], will create Release later"
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No [release] in commit, skip Release creation"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi
          
          echo "should_build=true" >> $GITHUB_OUTPUT
        shell: /usr/bin/bash -e {0}

      # 3. è·³è¿‡æ„å»ºï¼ˆå¦‚æœæ ‡è®°ä¸ºä¸æ„å»ºï¼‰
      - name: Skip build if needed
        if: steps.check_commit.outputs.should_build == 'false'
        run: |
          echo "Build aborted due to [miss build] in commit"
          exit 0
        shell: /usr/bin/bash -e {0}

      # 4. é…ç½®JDK 17ï¼ˆé€‚é…Paper 1.20+ï¼‰
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven # ç¼“å­˜Mavenä¾èµ–

      # 5. æå–ç‰ˆæœ¬å·ï¼ˆä¿®å¤åˆ†æ”¯åç¡¬ç¼–ç +å®¹é”™ï¼‰
      - name: Extract version
        id: extract_version
        run: |
          # å¼€å¯é”™è¯¯é€€å‡ºï¼Œä»»ä½•å‘½ä»¤å¤±è´¥ç«‹å³ç»ˆæ­¢
          set -e
          # ä¼˜å…ˆä»pom.xmlæå–ç‰ˆæœ¬å·ï¼ˆæ·»åŠ SSLå®¹é”™å‚æ•°ï¼‰
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true)
          # å®¹é”™ï¼šè‹¥Mavenå‘½ä»¤å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
          if [ -z "$VERSION" ]; then
            VERSION="1.0.0-SNAPSHOT"
            echo "âš ï¸ ä»pom.xmlæå–ç‰ˆæœ¬å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬ï¼š$VERSION"
          fi
          echo "åŸå§‹ç‰ˆæœ¬å·ï¼š$VERSION"
          
          # å¦‚æœæ˜¯å¿«ç…§ç‰ˆï¼Œè¿½åŠ æäº¤å“ˆå¸Œå’Œåˆ†æ”¯å
          if echo "$VERSION" | grep -qi "SNAPSHOT"; then
            # è·å–æäº¤å“ˆå¸Œï¼ˆå®¹é”™ï¼‰
            COMMIT_HASH=$(git rev-parse --short HEAD || echo "unknown")
            # è·å–GitHubåˆ†æ”¯åï¼ˆé€‚é…æ¨é€/PR/æ‰‹åŠ¨è§¦å‘ç­‰åœºæ™¯ï¼‰
            BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9_\-]/-/g')
            # å®¹é”™ï¼šè‹¥åˆ†æ”¯åä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼
            if [ -z "$BRANCH_NAME" ]; then
              BRANCH_NAME="unknown-branch"
            fi
            # æ‹¼æ¥ç‰ˆæœ¬å·ï¼ˆé¿å…é‡å¤åˆ†éš”ç¬¦ï¼‰
            VERSION="${VERSION}-${BRANCH_NAME}-${COMMIT_HASH}"
          fi
          
          # è¾“å‡ºç‰ˆæœ¬å·åˆ°GitHub Output
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… æœ€ç»ˆæå–ç‰ˆæœ¬å·ï¼š$VERSION"
        shell: /usr/bin/bash -e {0}
        env:
          JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.17-10/x64
          JAVA_HOME_17_X64: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.17-10/x64

      # 6. æ„å»ºMavené¡¹ç›®
      - name: Build with Maven
        id: build
        run: |
          # æ‰§è¡ŒMavenæ‰“åŒ…ï¼ˆæ·»åŠ SSLå®¹é”™å‚æ•°ï¼‰
          mvn clean package -B -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true
          # è·å–ç”Ÿæˆçš„JaråŒ…åç§°ï¼ˆè¿‡æ»¤original-å‰ç¼€çš„åŸå§‹åŒ…ï¼‰
          JAR_NAME=$(ls target/*.jar | grep -v "original-" | xargs -n1 basename || echo "TrafficLight-unknown.jar")
          echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT
          echo "Built Jar: $JAR_NAME"
          
          # å¤åˆ¶JaråŒ…åˆ°æ˜“è®¿é—®çš„ç›®å½•
          mkdir -p build-output
          cp target/$JAR_NAME build-output/ || echo "âš ï¸ JaråŒ…å¤åˆ¶å¤±è´¥ï¼Œæ£€æŸ¥æ„å»ºäº§ç‰©"
          ls -la build-output/
        shell: /usr/bin/bash -e {0}

      # 7. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrafficLight-${{ steps.extract_version.outputs.version }}
          path: build-output/*.jar
          retention-days: 7

  # è‡ªåŠ¨åˆ›å»ºReleaseä»»åŠ¡ï¼ˆä»…å½“æ ‡è®°ä¸ºéœ€è¦Releaseæ—¶æ‰§è¡Œï¼‰
  release:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.should_release == 'true'
    steps:
      # 1. ä¸‹è½½æ„å»ºäº§ç‰©
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: TrafficLight-${{ needs.build.outputs.version }}
          path: build-output

      # 2. åˆ›å»ºGitHub Releaseï¼ˆä¿®å¤è¡¨è¾¾å¼è¯­æ³•é”™è¯¯ï¼‰
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # ä¿®å¤ï¼šä½¿ç”¨formatå‡½æ•°æ‹¼æ¥ç‰ˆæœ¬å·ï¼Œé¿å…+å·è¯­æ³•é”™è¯¯
          tag_name: ${{ startsWith(needs.build.outputs.version, 'v') && needs.build.outputs.version || format('v{0}', needs.build.outputs.version) }}
          name: TrafficLight ${{ needs.build.outputs.version }} (${{ github.ref_name }})
          body: |
            ## ğŸš€ TrafficLight Release ${{ needs.build.outputs.version }}
            ### åˆ†æ”¯ï¼š${{ github.ref_name }} | æ„å»ºæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
            ### æäº¤å“ˆå¸Œï¼š${{ github.sha }} | æäº¤ä¿¡æ¯ï¼š${{ github.event.head_commit.message }}
            
            #### è‡ªåŠ¨æ„å»ºè¯´æ˜
            - åŸºäº `${{ github.ref_name }}` åˆ†æ”¯æœ€æ–°æäº¤æ„å»º
            - JaråŒ…é€‚é… Paper 1.20+ (Java 17)
            - æ„å»ºäº§ç‰©ï¼š${{ needs.build.outputs.jar_name }}
          # ä¸Šä¼ JaråŒ…åˆ°Releaseï¼ˆå®¹é”™ï¼‰
          files: build-output/${{ needs.build.outputs.jar_name }}
          # éä¸»åˆ†æ”¯æ ‡è®°ä¸ºé¢„å‘å¸ƒ
          prerelease: ${{ github.ref_name != 'main' && github.ref_name != 'master' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
